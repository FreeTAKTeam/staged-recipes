From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: conda-forge-admin <conda-forge-admin@conda-forge.org>
Date: Mon, 25 Nov 2024 10:00:00 +0000
Subject: [PATCH] Fix Windows MSVC compiler flags for protobuf files

This patch fixes MSVC compiler flag issues when building protobuf generated files:
1. Replaces direct use of "-w" flag with proper MSVC-aware warning disabling
2. Ensures /EHsc is always present for proper exception handling
3. Prevents D9025 warnings about conflicting /W4 and /w flags
4. Prevents C4530 errors by ensuring exception handling is enabled

The patch modifies how protobuf generated files are compiled to avoid
flag conflicts while maintaining proper exception handling.
---
 src/CMakeLists.txt | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 1234567..abcdefg 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -33,8 +33,20 @@ protobuf_generate(LANGUAGE cpp TARGET shared PROTOS ${UDP_PROTO_FILE} OUT_VAR B
 
 # Disable warnings for the generated source files
 foreach(CURRENT_FILE IN LISTS BUILT_PROTO_FILES BUILT_UDP_PROTO_FILES)
-	set_source_files_properties("${CURRENT_FILE}" PROPERTIES COMPILE_FLAGS "-w")
+	if(MSVC)
+		# For MSVC, use specific warning disables instead of /w to avoid conflicts
+		# and ensure exception handling is always enabled
+		set_source_files_properties("${CURRENT_FILE}" PROPERTIES 
+			COMPILE_FLAGS "/wd4996 /wd4244 /wd4267 /wd4005 /wd4800 /wd4018 /wd4065 /EHsc"
+		)
+	else()
+		# For GCC/Clang, use -w to disable all warnings
+		set_source_files_properties("${CURRENT_FILE}" PROPERTIES COMPILE_FLAGS "-w")
+	endif()
 endforeach()
 
+# Ensure the shared target always has exception handling enabled on MSVC
+if(MSVC)
+	target_compile_options(shared PRIVATE "/EHsc")
+endif()
+
 set_target_properties(shared
 	PROPERTIES
 		AUTOMOC ON
-- 
2.34.1